<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Stok (Supabase) - V4 (CSS Kustom)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/heroicons/1.0.6/css/solid.min.css">
    
    <style>
        /* Menggunakan font Inter sebagai default */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #F3F4F6; /* bg-gray-100 */
        }
        
        /* Loading Spinner */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2563EB; /* Warna primer */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 1. Komponen Card */
        .card {
            background-color: #ffffff;
            border-radius: 0.5rem; /* 8px */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #E5E7EB; /* border-gray-200 */
            overflow: hidden; /* Menjaga sudut bulat */
        }
        .card-header {
            padding: 1.5rem; /* p-6 */
            border-bottom: 1px solid #E5E7EB;
        }
        .card-body {
            padding: 1.5rem; /* p-6 */
        }
        .card-title {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #1F2937; /* text-gray-800 */
            margin-bottom: 1rem;
        }

        /* 2. Komponen Form */
        .form-label {
            display: block;
            margin-bottom: 0.5rem; /* mb-2 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #4B5563; /* text-gray-600 */
        }
        .form-input,
        .form-select {
            display: block;
            width: 100%;
            border: 1px solid #D1D5DB; /* border-gray-300 */
            border-radius: 0.375rem; /* 6px */
            padding: 0.75rem 1rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
        }
        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #2563EB; /* Warna primer */
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); /* Efek ring */
        }

        /* 3. Komponen Tombol (Button) */
        .btn {
            display: inline-block;
            width: 100%; /* Default tombol adalah full-width */
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.375rem; /* 6px */
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: #2563EB; /* blue-600 */
            color: white;
        }
        .btn-primary:hover { background-color: #1D4ED8; } /* blue-700 */

        .btn-success {
            background-color: #16A34A; /* green-600 */
            color: white;
        }
        .btn-success:hover { background-color: #15803D; } /* green-700 */

        .btn-error {
            background-color: #DC2626; /* red-600 */
            color: white;
        }
        .btn-error:hover { background-color: #B91C1C; } /* red-700 */
        
        /* 4. Komponen Alert (Notifikasi) */
        #message-box-container {
            position: fixed;
            top: 1.25rem; /* top-5 */
            right: 1.25rem; /* right-5 */
            z-index: 50;
            max-width: 24rem; /* max-w-sm */
            display: flex;
            flex-direction: column;
            gap: 1rem; /* Jarak antar notifikasi */
        }
        .alert {
            padding: 1rem;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: flex;
            align-items: center;
        }
        .alert-icon {
            flex-shrink: 0;
            width: 1.5rem; /* w-6 */
            height: 1.5rem; /* h-6 */
            margin-right: 0.75rem; /* mr-3 */
        }
        .alert-success {
            background-color: #D1FAE5; /* green-100 */
            color: #065F46; /* green-800 */
        }
        .alert-error {
            background-color: #FEE2E2; /* red-100 */
            color: #991B1B; /* red-800 */
        }

        /* 5. Komponen Tabel Kustom */
        .custom-table {
            width: 100%;
            min-width: 640px; /* min-w-full */
            border-collapse: collapse;
        }
        .custom-table thead {
            background-color: #F9FAFB; /* bg-gray-50 */
        }
        .custom-table th {
            padding: 0.75rem 1.5rem; /* px-6 py-3 */
            text-align: left;
            font-size: 0.75rem; /* text-xs */
            font-weight: 600; /* font-semibold */
            color: #6B7280; /* text-gray-500 */
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .custom-table tbody tr {
            border-bottom: 1px solid #E5E7EB; /* border-gray-200 */
        }
        .custom-table tbody tr:nth-child(even) {
            background-color: #F9FAFB; /* Zebra stripe */
        }
        .custom-table td {
            padding: 1rem 1.5rem; /* px-6 py-4 */
            font-size: 0.875rem; /* text-sm */
            color: #374151; /* text-gray-700 */
        }
        .badge {
            display: inline-block;
            padding: 0.25em 0.75em;
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 9999px; /* rounded-full */
        }
        .badge-success {
            background-color: #D1FAE5; /* green-100 */
            color: #065F46; /* green-800 */
        }
        .badge-error {
            background-color: #FEE2E2; /* red-100 */
            color: #991B1B; /* red-800 */
        }
        
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">

        <div id="loading-spinner" class="fixed inset-0 z-50 flex items-center justify-center bg-white bg-opacity-75">
            <div class="loader"></div>
        </div>

        <div id="message-box-container">
            </div>

        <div id="auth-container" class="hidden max-w-md mx-auto mt-10">
            <div class="card">
                <div class="card-body">
                    <img src="https://placehold.co/300x80/003366/FFFFFF?text=Perusahaan+Redesma" alt="Logo Perusahaan Redesma" class="mx-auto mb-6 rounded">
                    
                    <form id="login-form">
                        <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Login Sistem Stok</h2>
                        <div class="mb-4">
                            <label for="login-email" class="form-label">Email</label>
                            <input type="email" id="login-email" required class="form-input">
                        </div>
                        <div class="mb-6">
                            <label for="login-password" class="form-label">Password</label>
                            <input type="password" id="login-password" required class="form-input">
                        </div>
                        <button type="submit" class="btn btn-primary">
                            Masuk
                        </button>
                        <p class="text-center text-sm text-gray-500 mt-4">
                            Belum punya akun? 
                            <a href="#" id="show-register" class="text-blue-600 hover:underline font-medium">Daftar di sini</a>
                        </p>
                    </form>

                    <form id="register-form" class="hidden">
                        <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Daftar Akun Baru</h2>
                        <div class="mb-4">
                            <label for="register-email" class="form-label">Email</label>
                            <input type="email" id="register-email" required class="form-input">
                        </div>
                        <div class="mb-6">
                            <label for="register-password" class="form-label">Password</label>
                            <input type="password" id="register-password" required class="form-input">
                        </div>
                        <button type="submit" class="btn btn-success">
                            Daftar
                        </button>
                        <p class="text-center text-sm text-gray-500 mt-4">
                            Sudah punya akun? 
                            <a href="#" id="show-login" class="text-blue-600 hover:underline font-medium">Login di sini</a>
                        </p>
                    </form>
                </div>
            </div>
        </div>

        <div id="dashboard-container" class="hidden">
            <header class="flex flex-wrap justify-between items-center mb-6 p-4 bg-white rounded-lg shadow">
                <h1 class="text-3xl font-bold text-blue-800">Dashboard Stok Redesma</h1>
                <div class="flex items-center">
                    <span id="user-email" class="text-gray-600 mr-4 hidden md:block"></span>
                    <button id="logout-button" class="btn btn-error py-2 px-4 w-auto"> Logout
                    </button>
                </div>
            </header>

            <div class="card mb-6">
                <div class="card-body">
                    <h2 class="card-title">Grafik Stok Barang (Saat Ini)</h2>
                    <div class="h-64 md:h-80">
                        <canvas id="inventoryChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="md:col-span-1 card">
                    <div class="card-body">
                        <h2 class="card-title">Manajemen Master Barang</h2>
                        <form id="form-master-barang" class="space-y-4">
                            <div>
                                <label for="master-id" class="form-label">ID Barang (Unik)</label>
                                <input type="text" id="master-id" placeholder="Contoh: B001, A002" required class="form-input">
                            </div>
                            <div>
                                <label for="master-nama" class="form-label">Nama Barang</label>
                                <input type="text" id="master-nama" placeholder="Contoh: Baut 10mm" required class="form-input">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                Tambah Master Barang
                            </button>
                        </form>
                    </div>
                </div>
                <div class="md:col-span-2 card">
                    <div class="card-body">
                        <h2 class="card-title">List Master Barang</h2>
                        <div class="max-h-64 overflow-y-auto">
                            <table class="custom-table">
                                <thead>
                                    <tr>
                                        <th>ID Barang</th>
                                        <th>Nama Barang</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="table-master-barang">
                                    <tr><td colspan="3" class="p-4 text-center text-gray-500">Memuat data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title text-green-700">Input Barang Masuk</h2>
                        <form id="form-barang-masuk" class="space-y-4">
                            <div>
                                <label for="masuk-id" class="form-label">Pilih Barang</label>
                                <select id="masuk-id" required class="form-select">
                                    <option value="">Memuat barang...</option>
                                </select>
                            </div>
                            <div>
                                <label for="masuk-kuantitas" class="form-label">Kuantitas</label>
                                <input type="number" id="masuk-kuantitas" min="1" required class="form-input">
                            </div>
                            <button type="submit" class="btn btn-success">
                                Tambah Masuk
                            </button>
                        </form>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title text-red-700">Input Barang Keluar</h2>
                        <form id="form-barang-keluar" class="space-y-4">
                            <div>
                                <label for="keluar-id" class="form-label">Pilih Barang</label>
                                <select id="keluar-id" required class="form-select">
                                    <option value="">Memuat barang...</option>
                                </select>
                            </div>
                            <div>
                                <label for="keluar-kuantitas" class="form-label">Kuantitas</label>
                                <input type="number" id="keluar-kuantitas" min="1" required class="form-input">
                            </div>
                            <button type="submit" class="btn btn-error">
                                Tambah Keluar
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="card mb-6">
                <div class="card-body">
                    <label for="search-bar" class="form-label">
                        üîç Cari Cepat Riwayat (Berdasarkan ID atau Nama Barang)
                    </label>
                    <input type="text" id="search-bar" placeholder="Ketik ID (B001) atau Nama (Baut)..." class="form-input">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title text-green-700">Data Barang Masuk</h2>
                        <div class="overflow-x-auto">
                            <table class="custom-table">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>ID Barang</th>
                                        <th>Nama Barang</th>
                                        <th>Kuantitas</th>
                                        <th>Tanggal Masuk</th>
                                    </tr>
                                </thead>
                                <tbody id="table-barang-masuk">
                                    <tr><td colspan="5" class="p-4 text-center text-gray-500">Memuat data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title text-red-700">Data Barang Keluar</h2>
                        <div class="overflow-x-auto">
                            <table class="custom-table">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>ID Barang</th>
                                        <th>Nama Barang</th>
                                        <th>Kuantitas</th>
                                        <th>Tanggal Keluar</th>
                                    </tr>
                                </thead>
                                <tbody id="table-barang-keluar">
                                        <tr><td colspan="5" class="p-4 text-center text-gray-500">Memuat data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div> </div> <script type="module">
        // 4. Supabase Import
        const { createClient } = supabase;

        // ===================================================================
        // $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
        //          KONFIGURASI SUPABASE ANDA
        // ===================================================================

        const supabaseUrl = "https://kcwxjwtvjsdgobeygiau.supabase.co"; // <-- SUDAH DISET
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtjd3hqd3R2anNkZ29iZXlnaWF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMjMxNzMsImV4cCI6MjA3ODg5OTE3M30.BW7hqJIp1gbUejDNKVaf6A1jhz4bIXIFVCzztoiwuZU"; // <-- SUDAH DISET
        
        // ===================================================================
        // $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
        // ===================================================================


        // Inisialisasi Supabase
        const db = createClient(supabaseUrl, supabaseKey);
        console.log('Supabase client initialized');

        // Variabel Global
        let currentChart = null; 
        let realtimeChannel = null; 
        let masterBarangList = []; 

        // DOM Elements
        const loadingSpinner = document.getElementById('loading-spinner');
        const authContainer = document.getElementById('auth-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        const messageBoxContainer = document.getElementById('message-box-container'); // (DIUBAH)
        
        // Auth Forms
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');
        
        // Dashboard Elements
        const userEmailDisplay = document.getElementById('user-email');
        const logoutButton = document.getElementById('logout-button');
        const chartCanvas = document.getElementById('inventoryChart').getContext('2d');
        const searchBar = document.getElementById('search-bar');
        
        // Master Barang
        const formMasterBarang = document.getElementById('form-master-barang');
        const tableMasterBarang = document.getElementById('table-master-barang');
        const selectMasukId = document.getElementById('masuk-id');
        const selectKeluarId = document.getElementById('keluar-id');

        // Data Forms
        const formBarangMasuk = document.getElementById('form-barang-masuk');
        const formBarangKeluar = document.getElementById('form-barang-keluar');

        // Data Tables
        const tableBarangMasuk = document.getElementById('table-barang-masuk');
        const tableBarangKeluar = document.getElementById('table-barang-keluar');

        // === Fungsi Helper ===
        
        /** (DIPERBARUI) Menampilkan pesan notifikasi kustom */
        function showMessage(message, isError = false) {
            const alertType = isError ? 'alert-error' : 'alert-success';
            const iconSvg = isError 
                ? `<svg class="alert-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`
                : `<svg class="alert-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;

            // Buat elemen alert baru
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertType}`;
            alertDiv.innerHTML = `
                ${iconSvg}
                <span class="font-medium">${message}</span>
            `;
            
            // Tambahkan ke kontainer
            messageBoxContainer.appendChild(alertDiv);
            
            // Hapus setelah 3 detik
            setTimeout(() => {
                alertDiv.style.transition = 'opacity 0.5s ease-out';
                alertDiv.style.opacity = '0';
                setTimeout(() => alertDiv.remove(), 500); // Hapus dari DOM
            }, 3000);
        }

        /** Memformat obyek Tanggal (dari string ISO Supabase) menjadi string yang rapi */
        function formatTanggal(tanggalString) {
            if (!tanggalString) return 'N/A';
            const date = new Date(tanggalString); 
            return date.toLocaleString('id-ID', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        /** Memfilter tabel riwayat berdasarkan input pencarian */
        function filterTables() {
            const searchTerm = searchBar.value.trim().toUpperCase();
            
            const filterTBody = (tbody) => {
                const rows = tbody.querySelectorAll('tr');
                rows.forEach(row => {
                    const idCell = row.querySelector('td:nth-child(2)');
                    const nameCell = row.querySelector('td:nth-child(3)');
                    
                    if (!idCell || !nameCell) {
                        row.style.display = '';
                        return;
                    }
                    
                    const idBarang = idCell.textContent.toUpperCase();
                    const namaBarang = nameCell.textContent.toUpperCase();

                    if (idBarang.includes(searchTerm) || namaBarang.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            };

            filterTBody(tableBarangMasuk);
            filterTBody(tableBarangKeluar);
        }

        // === Fungsi Logika Utama ===

        /** 1. Mengambil data Master Barang */
        async function loadMasterBarang() {
            console.log("Fetching master barang...");
            try {
                const { data, error } = await db.from('master_barang').select('*').order('id_barang', { ascending: true });
                if (error) throw error;
                
                masterBarangList = data; 
                
                renderMasterBarangTable(masterBarangList);
                populateDropdowns(masterBarangList);

            } catch (error) {
                console.error("Error fetching master barang:", error);
                showMessage(`Gagal memuat master barang: ${error.message}`, true);
            }
        }

        /** 2. Mengambil data Transaksi (Masuk & Keluar) */
        async function fetchTransactionData() {
            console.log("Fetching transaction data...");
            try {
                const [masukResponse, keluarResponse] = await Promise.all([
                    db.from('barang_masuk').select('*, master_barang(nama_barang)').order('tanggal', { ascending: false }),
                    db.from('barang_keluar').select('*, master_barang(nama_barang)').order('tanggal', { ascending: false })
                ]);

                if (masukResponse.error) throw masukResponse.error;
                if (keluarResponse.error) throw keluarResponse.error;

                const dataMasuk = masukResponse.data;
                const dataKeluar = keluarResponse.data;

                renderTabelMasuk(dataMasuk);
                renderTabelKeluar(dataKeluar);
                updateChart(dataMasuk, dataKeluar);
                filterTables();

            } catch (error)
            {
                console.error("Error fetching data:", error);
                showMessage(`Gagal memuat data transaksi: ${error.message}`, true);
            }
        }
        
        /** Mengatur listener data real-time */
        function setupDataListeners() {
            if (realtimeChannel) {
                realtimeChannel.unsubscribe();
            }
            
            console.log("Setting up realtime listeners...");
            
            realtimeChannel = db.channel('public-changes')
                .on('postgres_changes', { 
                    event: '*', 
                    schema: 'public', 
                    table: 'master_barang' 
                }, (payload) => {
                    console.log('Perubahan master_barang terdeteksi!', payload);
                    showMessage("Data master barang berubah, memuat ulang...", false);
                    loadMasterBarang();
                })
                .on('postgres_changes', { 
                    event: 'INSERT', 
                    schema: 'public', 
                    table: 'barang_masuk' 
                }, (payload) => {
                    console.log('Perubahan barang_masuk terdeteksi!', payload);
                    showMessage("Data masuk baru terdeteksi, memuat ulang...", false);
                    fetchTransactionData();
                })
                .on('postgres_changes', { 
                    event: 'INSERT', 
                    schema: 'public', 
                    table: 'barang_keluar' 
                }, (payload) => {
                    console.log('Perubahan barang_keluar terdeteksi!', payload);
                    showMessage("Data keluar baru terdeteksi, memuat ulang...", false);
                    fetchTransactionData();
                })
                .subscribe((status, err) => {
                    if (status === 'SUBSCRIBED') {
                        console.log('Berhasil terhubung ke Realtime Supabase!');
                    }
                    if (status === 'CHANNEL_ERROR') {
                        console.error('Realtime connection error:', err);
                    }
                });
        }

        /** Menghentikan semua listener data (saat logout) */
        function cleanupListeners() {
            if (realtimeChannel) {
                realtimeChannel.unsubscribe();
                realtimeChannel = null;
                console.log("Realtime listeners stopped.");
            }
            masterBarangList = [];
        }

        // === Fungsi Render ===

        /** Render data ke tabel master barang */
        function renderMasterBarangTable(data) {
            tableMasterBarang.innerHTML = '';
            if (!data || data.length === 0) {
                tableMasterBarang.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">Belum ada master barang</td></tr>';
                return;
            }
            data.forEach(item => {
                const row = `
                    <tr>
                        <td class="font-medium">${item.id_barang}</td>
                        <td>${item.nama_barang}</td>
                        <td>
                            <button class="delete-btn p-1 text-red-600 hover:text-red-800" data-id="${item.id_barang}" title="Hapus ${item.nama_barang}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
                tableMasterBarang.innerHTML += row;
            });

            tableMasterBarang.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', handleDeleteMasterBarang);
            });
        }

        /** Isi dropdown form masuk & keluar */
        function populateDropdowns(data) {
            selectMasukId.innerHTML = '';
            selectKeluarId.innerHTML = '';

            if (!data || data.length === 0) {
                const noDataOption = '<option value="">Tambah Master Barang dulu</option>';
                selectMasukId.innerHTML = noDataOption;
                selectKeluarId.innerHTML = noDataOption;
                return;
            }

            const defaultOption = '<option value="">-- Pilih Barang --</option>';
            selectMasukId.innerHTML = defaultOption;
            selectKeluarId.innerHTML = defaultOption;

            data.forEach(item => {
                const option = `<option value="${item.id_barang}">${item.id_barang} - ${item.nama_barang}</option>`;
                selectMasukId.innerHTML += option;
                selectKeluarId.innerHTML += option;
            });
        }

        /** Render data ke tabel barang masuk */
        function renderTabelMasuk(data) {
            tableBarangMasuk.innerHTML = '';
            if (!data || data.length === 0) {
                tableBarangMasuk.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Belum ada data</td></tr>';
                return;
            }
            data.forEach((item, index) => {
                const namaBarang = item.master_barang ? item.master_barang.nama_barang : '(Data Hilang)';
                const row = `
                    <tr>
                        <td class="font-medium">${index + 1}</td>
                        <td class="font-medium">${item.id_barang}</td>
                        <td>${namaBarang}</td>
                        <td><span class="badge badge-success">+${item.kuantitas}</span></td>
                        <td class="text-sm text-gray-500">${formatTanggal(item.tanggal)}</td>
                    </tr>
                `;
                tableBarangMasuk.innerHTML += row;
            });
        }

        /** Render data ke tabel barang keluar */
        function renderTabelKeluar(data) {
            tableBarangKeluar.innerHTML = '';
            if (!data || data.length === 0) {
                tableBarangKeluar.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Belum ada data</td></tr>';
                return;
            }
            data.forEach((item, index) => {
                const namaBarang = item.master_barang ? item.master_barang.nama_barang : '(Data Hilang)';
                const row = `
                    <tr>
                        <td class="font-medium">${index + 1}</td>
                        <td class="font-medium">${item.id_barang}</td>
                        <td>${namaBarang}</td>
                        <td><span class="badge badge-error">-${item.kuantitas}</span></td>
                        <td class="text-sm text-gray-500">${formatTanggal(item.tanggal)}</td>
                    </tr>
                `;
                tableBarangKeluar.innerHTML += row;
            });
        }

        /** Mengolah data dan memperbarui chart */
        function updateChart(dataMasuk, dataKeluar) {
            const stokAkhir = {};

            (dataMasuk || []).forEach(item => {
                const id = item.id_barang.toUpperCase();
                stokAkhir[id] = (stokAkhir[id] || 0) + item.kuantitas;
            });

            (dataKeluar || []).forEach(item => {
                const id = item.id_barang.toUpperCase();
                stokAkhir[id] = (stokAkhir[id] || 0) - item.kuantitas;
            });

            const sortedLabels = Object.keys(stokAkhir).sort();
            
            const labels = sortedLabels.map(id => {
                const master = masterBarangList.find(m => m.id_barang === id);
                return master ? `${id} (${master.nama_barang})` : id;
            });
            const data = sortedLabels.map(id => stokAkhir[id]);

            if (currentChart) {
                currentChart.destroy();
            }

            // (BARU) Mengatur warna font chart agar sesuai
            const chartFontColor = '#374151'; // text-gray-700
            
            currentChart = new Chart(chartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Stok Barang Saat Ini',
                        data: data,
                        backgroundColor: 'rgba(37, 99, 235, 0.7)', // Warna primer (blue-600)
                        borderColor: 'rgba(37, 99, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            ticks: { color: chartFontColor },
                            grid: { color: '#E5E7EB' }
                        },
                        x: {
                            ticks: { color: chartFontColor },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: chartFontColor }
                        }
                    }
                }
            });
        }


        // === Event Listener ===

        db.auth.onAuthStateChange((event, session) => {
            if (session) {
                const user = session.user;
                console.log("User logged in:", user.email);
                authContainer.classList.add('hidden');
                dashboardContainer.classList.remove('hidden');
                userEmailDisplay.textContent = user.email;
                
                loadMasterBarang();
                fetchTransactionData();
                setupDataListeners();

            } else {
                console.log("User logged out");
                authContainer.classList.remove('hidden');
                dashboardContainer.classList.add('hidden');
                userEmailDisplay.textContent = '';
                
                cleanupListeners();
                
                if (currentChart) currentChart.destroy();
                tableBarangMasuk.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Silakan login</td></tr>';
                tableBarangKeluar.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Silakan login</td></tr>';
                tableMasterBarang.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">Silakan login</td></tr>';
            }
            loadingSpinner.classList.add('hidden'); // Ini akan menyembunyikan spinner SETELAH status auth didapat
        });

        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        });

        searchBar.addEventListener('input', filterTables);

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            loadingSpinner.classList.remove('hidden');

            try {
                const { error } = await db.auth.signUp({ email, password });
                if (error) throw error;
                showMessage("Akun berhasil dibuat! Silakan cek email Anda untuk konfirmasi.", false);
            } catch (error) {
                console.error("Register error:", error);
                showMessage(`Gagal mendaftar: ${error.message}`, true);
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            loadingSpinner.classList.remove('hidden');

            try {
                const { error } = await db.auth.signInWithPassword({ email, password });
                if (error) throw error;
                showMessage("Login berhasil!", false);
            } catch (error) {
                console.error("Login error:", error);
                showMessage(`Gagal login: ${error.message}`, true);
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        });

        logoutButton.addEventListener('click', async () => {
            loadingSpinner.classList.remove('hidden');
            try {
                const { error } = await db.auth.signOut();
                if (error) throw error;
                showMessage("Anda telah logout.", false);
            } catch (error) {
                console.error("Logout error:", error);
                showMessage(`Gagal logout: ${error.message}`, true);
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        });

        formMasterBarang.addEventListener('submit', async (e) => {
            e.preventDefault();
            const idBarang = document.getElementById('master-id').value.toUpperCase();
            const namaBarang = document.getElementById('master-nama').value;
            
            if (!idBarang || !namaBarang) {
                showMessage("ID Barang dan Nama Barang tidak boleh kosong.", true);
                return;
            }

            try {
                const { error } = await db.from('master_barang').insert({ 
                    id_barang: idBarang, 
                    nama_barang: namaBarang 
                });
                if (error) throw error;
                
                showMessage(`Barang ${namaBarang} berhasil ditambah!`, false);
                formMasterBarang.reset();
            } catch (error) {
                console.error("Error add master barang:", error);
                if (error.code === '23505') {
                    showMessage(`Gagal: ID Barang "${idBarang}" sudah ada. Gunakan ID lain.`, true);
                } else {
                    showMessage(`Gagal simpan master: ${error.message}`, true);
                }
            }
        });

        async function handleDeleteMasterBarang(e) {
            const idBarang = e.currentTarget.dataset.id;
            if (!idBarang) return;

            if (!confirm(`Yakin ingin menghapus barang ${idBarang}? \n\nPERINGATAN: Ini bisa gagal jika barang ini sudah pernah digunakan di riwayat Masuk/Keluar.`)) {
                return;
            }

            try {
                const { error } = await db.from('master_barang').delete().eq('id_barang', idBarang);
                if (error) throw error;
                showMessage(`Barang ${idBarang} berhasil dihapus.`, false);
            } catch (error) {
                console.error("Error deleting master barang:", error);
                if (error.code === '23503') {
                    showMessage(`Gagal hapus: Barang ${idBarang} sudah tercatat di riwayat Masuk/Keluar.`, true);
                } else {
                    showMessage(`Gagal hapus: ${error.message}`, true);
                }
            }
        }

        formBarangMasuk.addEventListener('submit', async (e) => {
            e.preventDefault();
            const idBarang = selectMasukId.value;
            const kuantitas = parseInt(document.getElementById('masuk-kuantitas').value);
            
            if (!idBarang) {
                showMessage("Silakan pilih barang terlebih dahulu.", true);
                return;
            }

            const { data: { user } } = await db.auth.getUser();
            if (!user) {
                showMessage("Sesi Anda berakhir, silakan login ulang.", true);
                return;
            }

            try {
                const { error } = await db.from('barang_masuk').insert({ 
                    id_barang: idBarang, 
                    kuantitas: kuantitas,
                    user_id: user.id
                });
                if (error) throw error;
                
                showMessage("Data barang masuk berhasil ditambah!", false);
                formBarangMasuk.reset();
                selectMasukId.value = "";
            } catch (error) {
                console.error("Error add barang masuk:", error);
                showMessage(`Gagal simpan data: ${error.message}`, true);
            }
        });

        formBarangKeluar.addEventListener('submit', async (e) => {
            e.preventDefault();
            const idBarang = selectKeluarId.value;
            const kuantitas = parseInt(document.getElementById('keluar-kuantitas').value);
            
            if (!idBarang) {
                showMessage("Silakan pilih barang terlebih dahulu.", true);
                return;
            }

            const { data: { user } } = await db.auth.getUser();
            if (!user) {
                showMessage("Sesi Anda berakhir, silakan login ulang.", true);
                return;
            }

            try {
                // Validasi stok
                const { data: dataMasuk, error: errMasuk } = await db.from('barang_masuk')
                    .select('kuantitas')
                    .eq('id_barang', idBarang);
                if (errMasuk) throw errMasuk;

                const { data: dataKeluar, error: errKeluar } = await db.from('barang_keluar')
                    .select('kuantitas')
                    .eq('id_barang', idBarang);
                if (errKeluar) throw errKeluar;

                let totalMasuk = 0;
                (dataMasuk || []).forEach(item => { totalMasuk += item.kuantitas; });
                
                let totalKeluar = 0;
                (dataKeluar || []).forEach(item => { totalKeluar += item.kuantitas; });

                const stokSaatIni = totalMasuk - totalKeluar;
                
                if (kuantitas > stokSaatIni) {
                    showMessage(`Gagal: Stok ${idBarang} tidak cukup. Stok saat ini: ${stokSaatIni}`, true);
                    return;
                }

                const { error } = await db.from('barang_keluar').insert({ 
                    id_barang: idBarang, 
                    kuantitas: kuantitas,
                    user_id: user.id
                });
                if (error) throw error;
                
                showMessage("Data barang keluar berhasil ditambah!", false);
                formBarangKeluar.reset();
                selectKeluarId.value = "";
            } catch (error) {
                console.error("Error add barang keluar:", error);
                showMessage(`Gagal simpan data: ${error.message}`, true);
            }
        });

    </script>
</body>
</html>
