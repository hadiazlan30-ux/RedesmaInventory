<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-R">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Stok (Supabase) - Redesma V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/heroicons/1.0.6/css/solid.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style untuk tombol delete */
        .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #EF4444; /* red-500 */
        }
        .delete-btn:hover {
            color: #B91C1C; /* red-700 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">

        <div id="loading-spinner" class="fixed inset-0 z-50 flex items-center justify-center bg-white bg-opacity-75">
            <div class="loader"></div>
        </div>

        <div id="message-box" class="hidden fixed top-5 right-5 z-50 p-4 rounded-lg shadow-md max-w-sm"></div>

        <div id="auth-container" class="hidden max-w-md mx-auto mt-10">
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <img src="https://placehold.co/300x80/003366/FFFFFF?text=Perusahaan+Redesma" alt="Logo Perusahaan Redesma" class="mx-auto mb-6 rounded">
                
                <form id="login-form">
                    <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Login Sistem Stok</h2>
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-600 mb-2">Email</label>
                        <input type="email" id="login-email" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-gray-600 mb-2">Password</label>
                        <input type="password" id="login-password" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-200">
                        Masuk
                    </button>
                    <p class="text-center text-sm text-gray-500 mt-4">
                        Belum punya akun? 
                        <a href="#" id="show-register" class="text-blue-600 hover:underline">Daftar di sini</a>
                    </p>
                </form>

                <form id="register-form" class="hidden">
                    <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Daftar Akun Baru</h2>
                    <div class="mb-4">
                        <label for="register-email" class="block text-sm font-medium text-gray-600 mb-2">Email</label>
                        <input type="email" id="register-email" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="mb-6">
                        <label for="register-password" class="block text-sm font-medium text-gray-600 mb-2">Password</label>
                        <input type="password" id="register-password" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-200">
                        Daftar
                    </button>
                    <p class="text-center text-sm text-gray-500 mt-4">
                        Sudah punya akun? 
                        <a href="#" id="show-login" class="text-blue-600 hover:underline">Login di sini</a>
                    </p>
                </form>
            </div>
        </div>

        <div id="dashboard-container" class="hidden">
            <header class="flex flex-wrap justify-between items-center mb-6 p-4 bg-white rounded-lg shadow">
                <h1 class="text-3xl font-bold text-blue-800">Dashboard Stok Redesma</h1>
                <div>
                    <span id="user-email" class="text-gray-600 mr-4"></span>
                    <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                        Logout
                    </button>
                </div>
            </header>

            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Grafik Stok Barang (Saat Ini)</h2>
                <div class="h-64 md:h-80">
                    <canvas id="inventoryChart"></canvas>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="md:col-span-1 bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-4 text-blue-700">Manajemen Master Barang</h2>
                    <form id="form-master-barang" class="space-y-4">
                        <div>
                            <label for="master-id" class="block text-sm font-medium text-gray-600">ID Barang (Unik)</label>
                            <input type="text" id="master-id" placeholder="Contoh: B001, A002" required class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="master-nama" class="block text-sm font-medium text-gray-600">Nama Barang</label>
                            <input type="text" id="master-nama" placeholder="Contoh: Baut 10mm, Kabel Merah" required class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                            Tambah Master Barang
                        </button>
                    </form>
                </div>
                <div class="md:col-span-2 bg-white p-6 rounded-lg shadow overflow-x-auto">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">List Master Barang</h2>
                    <div class="max-h-64 overflow-y-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Barang</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Barang</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="table-master-barang" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="3" class="p-4 text-center text-gray-500">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-4 text-green-700">Input Barang Masuk</h2>
                    <form id="form-barang-masuk" class="space-y-4">
                        <div>
                            <label for="masuk-id" class="block text-sm font-medium text-gray-600">Pilih Barang</label>
                            <select id="masuk-id" required class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">Memuat barang...</option>
                            </select>
                        </div>
                        <div>
                            <label for="masuk-kuantitas" class="block text-sm font-medium text-gray-600">Kuantitas</label>
                            <input type="number" id="masuk-kuantitas" min="1" required class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                            Tambah Masuk
                        </button>
                    </form>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-4 text-red-700">Input Barang Keluar</h2>
                    <form id="form-barang-keluar" class="space-y-4">
                        <div>
                            <label for="keluar-id" class="block text-sm font-medium text-gray-600">Pilih Barang</label>
                            <select id="keluar-id" required class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                                <option value="">Memuat barang...</option>
                            </select>
                        </div>
                        <div>
                            <label for="keluar-kuantitas" class="block text-sm font-medium text-gray-600">Kuantitas</label>
                            <input type="number" id="keluar-kuantitas" min="1" required class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        </div>
                        <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                            Tambah Keluar
                        </button>
                    </form>
                </div>
            </div>

            <div class="bg-white p-4 rounded-lg shadow mb-6">
                <label for="search-bar" class="block text-sm font-medium text-gray-600 mb-2">
                    üîç Cari Cepat Riwayat (Berdasarkan ID atau Nama Barang)
                </label>
                <input type="text" id="search-bar" placeholder="Ketik ID (B001) atau Nama (Baut)..." class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow overflow-x-auto">
                    <h2 class="text-xl font-semibold mb-4 text-green-700">Data Barang Masuk</h2>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Barang</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Barang</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kuantitas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Masuk</th>
                            </tr>
                        </thead>
                        <tbody id="table-barang-masuk" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="5" class="p-4 text-center text-gray-500">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="bg-white p-6 rounded-lg shadow overflow-x-auto">
                    <h2 class="text-xl font-semibold mb-4 text-red-700">Data Barang Keluar</h2>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Barang</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Barang</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kuantitas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Keluar</th>
                            </tr>
                        </thead>
                        <tbody id="table-barang-keluar" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="5" class="p-4 text-center text-gray-500">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div> </div> <script type="module">
        // 4. Supabase Import
        // Ini berfungsi karena kita sudah memuat script Supabase di <head>
        const { createClient } = supabase;

        
        // ===================================================================
        // $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
        //
        //          KONFIGURASI SUPABASE ANDA SUDAH SAYA MASUKKAN
        //
        // $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
        // ===================================================================

        const supabaseUrl = "https://kcwxjwtvjsdgobeygiau.supabase.co"; // <-- SUDAH DISET
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtjd3hqd3R2anNkZ29iZXlnaWF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMjMxNzMsImV4cCI6MjA3ODg5OTE3M30.BW7hqJIp1gbUejDNKVaf6A1jhz4bIXIFVCzztoiwuZU"; // <-- SUDAH DISET
        
        // ===================================================================
        // $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
        // ===================================================================


        // Inisialisasi Supabase
        const db = createClient(supabaseUrl, supabaseKey);
        console.log('Supabase client initialized');

        // Variabel Global
        let currentChart = null; // Menyimpan instance chart
        let realtimeChannel = null; // Menyimpan channel realtime
        let masterBarangList = []; // (BARU) Menyimpan cache master barang

        // DOM Elements
        const loadingSpinner = document.getElementById('loading-spinner');
        const authContainer = document.getElementById('auth-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        const messageBox = document.getElementById('message-box');
        
        // Auth Forms
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');
        
        // Dashboard Elements
        const userEmailDisplay = document.getElementById('user-email');
        const logoutButton = document.getElementById('logout-button');
        const chartCanvas = document.getElementById('inventoryChart').getContext('2d');
        const searchBar = document.getElementById('search-bar');
        
        // (BARU) Master Barang
        const formMasterBarang = document.getElementById('form-master-barang');
        const tableMasterBarang = document.getElementById('table-master-barang');
        const selectMasukId = document.getElementById('masuk-id');
        const selectKeluarId = document.getElementById('keluar-id');

        // Data Forms
        const formBarangMasuk = document.getElementById('form-barang-masuk');
        const formBarangKeluar = document.getElementById('form-barang-keluar');

        // Data Tables
        const tableBarangMasuk = document.getElementById('table-barang-masuk');
        const tableBarangKeluar = document.getElementById('table-barang-keluar');

        // === Fungsi Helper ===
        
        /** Menampilkan pesan notifikasi */
        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.className = 'hidden'; // Reset
            messageBox.classList.add(isError ? 'bg-red-200' : 'bg-green-200');
            messageBox.classList.add(isError ? 'text-red-800' : 'text-green-800');
            messageBox.classList.remove('hidden');
            
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }

        /** Memformat obyek Tanggal (dari string ISO Supabase) menjadi string yang rapi */
        function formatTanggal(tanggalString) {
            if (!tanggalString) return 'N/A';
            const date = new Date(tanggalString); 
            return date.toLocaleString('id-ID', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        /** (BARU) Memfilter tabel riwayat berdasarkan input pencarian */
        function filterTables() {
            const searchTerm = searchBar.value.trim().toUpperCase();
            
            // Fungsi internal untuk memfilter satu tabel
            const filterTBody = (tbody) => {
                const rows = tbody.querySelectorAll('tr');
                rows.forEach(row => {
                    // Kolom ID Barang (index 1), Nama Barang (index 2)
                    const idCell = row.querySelector('td:nth-child(2)');
                    const nameCell = row.querySelector('td:nth-child(3)');
                    
                    // Lewati jika baris 'no data' atau 'loading'
                    if (!idCell || !nameCell) {
                        row.style.display = '';
                        return;
                    }
                    
                    const idBarang = idCell.textContent.toUpperCase();
                    const namaBarang = nameCell.textContent.toUpperCase();

                    if (idBarang.includes(searchTerm) || namaBarang.includes(searchTerm)) {
                        row.style.display = ''; // Tampilkan baris
                    } else {
                        row.style.display = 'none'; // Sembunyikan baris
                    }
                });
            };

            // Terapkan filter ke kedua tabel
            filterTBody(tableBarangMasuk);
            filterTBody(tableBarangKeluar);
        }

        // === Fungsi Logika Utama ===

        /** (BARU) 1. Mengambil data Master Barang */
        async function loadMasterBarang() {
            console.log("Fetching master barang...");
            try {
                const { data, error } = await db.from('master_barang').select('*').order('id_barang', { ascending: true });
                if (error) throw error;
                
                masterBarangList = data; // Simpan di cache
                
                renderMasterBarangTable(masterBarangList);
                populateDropdowns(masterBarangList);

            } catch (error) {
                console.error("Error fetching master barang:", error);
                showMessage(`Gagal memuat master barang: ${error.message}`, true);
            }
        }

        /** (BARU) 2. Mengambil data Transaksi (Masuk & Keluar) */
        async function fetchTransactionData() {
            console.log("Fetching transaction data...");
            try {
                // Ambil data masuk dan keluar secara paralel
                // (BARU) Gunakan JOIN (select) untuk mengambil nama_barang dari master_barang
                const [masukResponse, keluarResponse] = await Promise.all([
                    db.from('barang_masuk').select('*, master_barang(nama_barang)').order('tanggal', { ascending: false }),
                    db.from('barang_keluar').select('*, master_barang(nama_barang)').order('tanggal', { ascending: false })
                ]);

                if (masukResponse.error) throw masukResponse.error;
                if (keluarResponse.error) throw keluarResponse.error;

                const dataMasuk = masukResponse.data;
                const dataKeluar = keluarResponse.data;

                // Render data ke UI
                renderTabelMasuk(dataMasuk);
                renderTabelKeluar(dataKeluar);
                updateChart(dataMasuk, dataKeluar);

                // Terapkan filter yang mungkin sudah ada
                filterTables();

            } catch (error) {
                console.error("Error fetching data:", error);
                showMessage(`Gagal memuat data transaksi: ${error.message}`, true);
            }
        }
        
        /**
         * (BARU) Mengatur "pendengar" (listener) data real-time dari Supabase.
         * Sekarang mendengarkan 3 tabel.
         */
        function setupDataListeners() {
            // Hentikan listener lama jika ada
            if (realtimeChannel) {
                realtimeChannel.unsubscribe();
            }
            
            console.log("Setting up realtime listeners...");
            
            realtimeChannel = db.channel('public-changes')
                .on('postgres_changes', { 
                    event: '*', // Apapun (INSERT, UPDATE, DELETE)
                    schema: 'public', 
                    table: 'master_barang' 
                }, (payload) => {
                    console.log('Perubahan master_barang terdeteksi!', payload);
                    showMessage("Data master barang berubah, memuat ulang...", false);
                    loadMasterBarang(); // Muat ulang master list
                })
                .on('postgres_changes', { 
                    event: 'INSERT', 
                    schema: 'public', 
                    table: 'barang_masuk' 
                }, (payload) => {
                    console.log('Perubahan barang_masuk terdeteksi!', payload);
                    showMessage("Data masuk baru terdeteksi, memuat ulang...", false);
                    fetchTransactionData(); // Muat ulang data transaksi
                })
                .on('postgres_changes', { 
                    event: 'INSERT', 
                    schema: 'public', 
                    table: 'barang_keluar' 
                }, (payload) => {
                    console.log('Perubahan barang_keluar terdeteksi!', payload);
                    showMessage("Data keluar baru terdeteksi, memuat ulang...", false);
                    fetchTransactionData(); // Muat ulang data transaksi
                })
                .subscribe((status, err) => {
                    if (status === 'SUBSCRIBED') {
                        console.log('Berhasil terhubung ke Realtime Supabase!');
                    }
                    if (status === 'CHANNEL_ERROR') {
                        console.error('Realtime connection error:', err);
                    }
                });
        }

        /** Menghentikan semua listener data (saat logout) */
        function cleanupListeners() {
            if (realtimeChannel) {
                realtimeChannel.unsubscribe();
                realtimeChannel = null;
                console.log("Realtime listeners stopped.");
            }
            masterBarangList = []; // Kosongkan cache
        }

        // === Fungsi Render ===

        /** (BARU) Render data ke tabel master barang */
        function renderMasterBarangTable(data) {
            tableMasterBarang.innerHTML = '';
            if (!data || data.length === 0) {
                tableMasterBarang.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">Belum ada master barang</td></tr>';
                return;
            }
            data.forEach(item => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap font-medium">${item.id_barang}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${item.nama_barang}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button class="delete-btn" data-id="${item.id_barang}" title="Hapus ${item.nama_barang}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
                tableMasterBarang.innerHTML += row;
            });

            // (BARU) Tambahkan event listener untuk tombol delete
            tableMasterBarang.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', handleDeleteMasterBarang);
            });
        }

        /** (BARU) Isi dropdown form masuk & keluar */
        function populateDropdowns(data) {
            selectMasukId.innerHTML = '';
            selectKeluarId.innerHTML = '';

            if (!data || data.length === 0) {
                const noDataOption = '<option value="">Silakan tambah Master Barang dulu</option>';
                selectMasukId.innerHTML = noDataOption;
                selectKeluarId.innerHTML = noDataOption;
                return;
            }

            const defaultOption = '<option value="">-- Pilih Barang --</option>';
            selectMasukId.innerHTML = defaultOption;
            selectKeluarId.innerHTML = defaultOption;

            data.forEach(item => {
                const option = `<option value="${item.id_barang}">${item.id_barang} - ${item.nama_barang}</option>`;
                selectMasukId.innerHTML += option;
                selectKeluarId.innerHTML += option;
            });
        }

        /** (DIPERBARUI) Render data ke tabel barang masuk (dengan nama barang) */
        function renderTabelMasuk(data) {
            tableBarangMasuk.innerHTML = '';
            if (!data || data.length === 0) {
                tableBarangMasuk.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Belum ada data</td></tr>';
                return;
            }
            data.forEach((item, index) => {
                // (BARU) Ambil nama barang dari data join
                const namaBarang = item.master_barang ? item.master_barang.nama_barang : '(Data Master Hilang)';
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-medium">${item.id_barang}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${namaBarang}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-green-600 font-bold">+${item.kuantitas}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatTanggal(item.tanggal)}</td>
                    </tr>
                `;
                tableBarangMasuk.innerHTML += row;
            });
        }

        /** (DIPERBARUI) Render data ke tabel barang keluar (dengan nama barang) */
        function renderTabelKeluar(data) {
            tableBarangKeluar.innerHTML = '';
            if (!data || data.length === 0) {
                tableBarangKeluar.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Belum ada data</td></tr>';
                return;
            }
            data.forEach((item, index) => {
                // (BARU) Ambil nama barang dari data join
                const namaBarang = item.master_barang ? item.master_barang.nama_barang : '(Data Master Hilang)';
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-medium">${item.id_barang}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${namaBarang}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-red-600 font-bold">-${item.kuantitas}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatTanggal(item.tanggal)}</td>
                    </tr>
                `;
                tableBarangKeluar.innerHTML += row;
            });
        }

        /** Mengolah data dan memperbarui chart */
        function updateChart(dataMasuk, dataKeluar) {
            const stokAkhir = {};

            // 1. Hitung total barang masuk
            (dataMasuk || []).forEach(item => {
                const id = item.id_barang.toUpperCase();
                stokAkhir[id] = (stokAkhir[id] || 0) + item.kuantitas;
            });

            // 2. Kurangi dengan total barang keluar
            (dataKeluar || []).forEach(item => {
                const id = item.id_barang.toUpperCase();
                stokAkhir[id] = (stokAkhir[id] || 0) - item.kuantitas;
            });

            // 3. Siapkan data untuk Chart.js
            const sortedLabels = Object.keys(stokAkhir).sort();
            
            // (BARU) Gunakan nama barang + ID untuk label chart
            const labels = sortedLabels.map(id => {
                const master = masterBarangList.find(m => m.id_barang === id);
                return master ? `${id} (${master.nama_barang})` : id;
            });
            const data = sortedLabels.map(id => stokAkhir[id]);

            if (currentChart) {
                currentChart.destroy();
            }

            currentChart = new Chart(chartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Stok Barang Saat Ini',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }


        // === Event Listener ===

        // Pengatur utama status login
        db.auth.onAuthStateChange((event, session) => {
            if (session) {
                // User sudah login
                const user = session.user;
                console.log("User logged in:", user.email);
                authContainer.classList.add('hidden');
                dashboardContainer.classList.remove('hidden');
                userEmailDisplay.textContent = user.email;
                
                // (BARU) Ambil data master dulu, baru data transaksi
                loadMasterBarang();
                fetchTransactionData();
                setupDataListeners();

            } else {
                // User belum login (atau sudah logout)
                console.log("User logged out");
                authContainer.classList.remove('hidden');
                dashboardContainer.classList.add('hidden');
                userEmailDisplay.textContent = '';
                
                // Hentikan mendengarkan data
                cleanupListeners();
                
                // Bersihkan tabel & chart
                if (currentChart) currentChart.destroy();
                tableBarangMasuk.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Silakan login</td></tr>';
                tableBarangKeluar.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Silakan login</td></tr>';
                tableMasterBarang.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">Silakan login</td></tr>';
            }
            loadingSpinner.classList.add('hidden');
        });

        // Toggle Form Login/Register
        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        });

        // (BARU) Handle Search Bar Input
        searchBar.addEventListener('input', filterTables);

        // Handle Register
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            loadingSpinner.classList.remove('hidden');

            try {
                const { error } = await db.auth.signUp({ email, password });
                if (error) throw error;
                // Supabase otomatis mengirim email konfirmasi. 
                showMessage("Akun berhasil dibuat! Silakan cek email Anda untuk konfirmasi.", false);
            } catch (error) {
                console.error("Register error:", error);
                showMessage(`Gagal mendaftar: ${error.message}`, true);
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        });

        // Handle Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            loadingSpinner.classList.remove('hidden');

            try {
                const { error } = await db.auth.signInWithPassword({ email, password });
                if (error) throw error;
                // onAuthStateChange akan otomatis menangani sisanya
                showMessage("Login berhasil!", false);
            } catch (error) {
                console.error("Login error:", error);
                showMessage(`Gagal login: ${error.message}`, true);
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        });

        // Handle Logout
        logoutButton.addEventListener('click', async () => {
            loadingSpinner.classList.remove('hidden');
            try {
                const { error } = await db.auth.signOut();
                if (error) throw error;
                // onAuthStateChange akan otomatis menangani sisanya
                showMessage("Anda telah logout.", false);
            } catch (error) {
                console.error("Logout error:", error);
                showMessage(`Gagal logout: ${error.message}`, true);
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        });

        // (BARU) Handle Form Master Barang
        formMasterBarang.addEventListener('submit', async (e) => {
            e.preventDefault();
            const idBarang = document.getElementById('master-id').value.toUpperCase();
            const namaBarang = document.getElementById('master-nama').value;
            
            if (!idBarang || !namaBarang) {
                showMessage("ID Barang dan Nama Barang tidak boleh kosong.", true);
                return;
            }

            try {
                const { error } = await db.from('master_barang').insert({ 
                    id_barang: idBarang, 
                    nama_barang: namaBarang 
                });
                if (error) throw error;
                
                showMessage(`Barang ${namaBarang} berhasil ditambah!`, false);
                formMasterBarang.reset();
                // Fitur Realtime akan otomatis mengambil data baru
            } catch (error) {
                console.error("Error add master barang:", error);
                if (error.code === '23505') { // Kode error untuk unique violation
                    showMessage(`Gagal: ID Barang "${idBarang}" sudah ada. Gunakan ID lain.`, true);
                } else {
                    showMessage(`Gagal simpan master: ${error.message}`, true);
                }
            }
        });

        // (BARU) Handle Delete Master Barang
        async function handleDeleteMasterBarang(e) {
            const idBarang = e.currentTarget.dataset.id;
            if (!idBarang) return;

            if (!confirm(`Yakin ingin menghapus barang ${idBarang}? \n\nPERINGATAN: Ini bisa gagal jika barang ini sudah pernah digunakan di riwayat Masuk/Keluar.`)) {
                return;
            }

            try {
                const { error } = await db.from('master_barang').delete().eq('id_barang', idBarang);
                if (error) throw error;
                showMessage(`Barang ${idBarang} berhasil dihapus.`, false);
                // Realtime akan mengurus update UI
            } catch (error) {
                console.error("Error deleting master barang:", error);
                if (error.code === '23503') { // Kode error untuk foreign key violation
                    showMessage(`Gagal hapus: Barang ${idBarang} sudah tercatat di riwayat Masuk/Keluar.`, true);
                } else {
                    showMessage(`Gagal hapus: ${error.message}`, true);
                }
            }
        }

        // (DIPERBARUI) Handle Form Barang Masuk (dari dropdown)
        formBarangMasuk.addEventListener('submit', async (e) => {
            e.preventDefault();
            const idBarang = selectMasukId.value; // Ambil dari select
            const kuantitas = parseInt(document.getElementById('masuk-kuantitas').value);
            
            if (!idBarang) {
                showMessage("Silakan pilih barang terlebih dahulu.", true);
                return;
            }

            const { data: { user } } = await db.auth.getUser();
            if (!user) {
                showMessage("Sesi Anda berakhir, silakan login ulang.", true);
                return;
            }

            try {
                const { error } = await db.from('barang_masuk').insert({ 
                    id_barang: idBarang, // id_barang dari dropdown
                    kuantitas: kuantitas,
                    user_id: user.id // Simpan siapa yg input
                });
                if (error) throw error;
                
                showMessage("Data barang masuk berhasil ditambah!", false);
                formBarangMasuk.reset();
                selectMasukId.value = ""; // Reset dropdown
                // Fitur Realtime akan otomatis mengambil data baru
            } catch (error) {
                console.error("Error add barang masuk:", error);
                showMessage(`Gagal simpan data: ${error.message}`, true);
            }
        });

        // (DIPERBARUI) Handle Form Barang Keluar (dari dropdown)
        formBarangKeluar.addEventListener('submit', async (e) => {
            e.preventDefault();
            const idBarang = selectKeluarId.value; // Ambil dari select
            const kuantitas = parseInt(document.getElementById('keluar-kuantitas').value);
            
            if (!idBarang) {
                showMessage("Silakan pilih barang terlebih dahulu.", true);
                return;
            }

            const { data: { user } } = await db.auth.getUser();
            if (!user) {
                showMessage("Sesi Anda berakhir, silakan login ulang.", true);
                return;
            }

            try {
                // Validasi stok sebelum mengurangi
                // Ambil total masuk untuk barang ini
                const { data: dataMasuk, error: errMasuk } = await db.from('barang_masuk')
                    .select('kuantitas')
                    .eq('id_barang', idBarang);
                if (errMasuk) throw errMasuk;

                // Ambil total keluar untuk barang ini
                const { data: dataKeluar, error: errKeluar } = await db.from('barang_keluar')
                    .select('kuantitas')
                    .eq('id_barang', idBarang);
                if (errKeluar) throw errKeluar;

                let totalMasuk = 0;
                (dataMasuk || []).forEach(item => { totalMasuk += item.kuantitas; });
                
                let totalKeluar = 0;
                (dataKeluar || []).forEach(item => { totalKeluar += item.kuantitas; });

                const stokSaatIni = totalMasuk - totalKeluar;
                
                // Cek apakah stok mencukupi
                if (kuantitas > stokSaatIni) {
                    showMessage(`Gagal: Stok ${idBarang} tidak cukup. Stok saat ini: ${stokSaatIni}`, true);
                    return; // Hentikan proses jika stok tidak cukup
                }

                // Jika stok cukup, lanjutkan proses insert
                const { error } = await db.from('barang_keluar').insert({ 
                    id_barang: idBarang, 
                    kuantitas: kuantitas,
                    user_id: user.id
                });
                if (error) throw error;
                
                showMessage("Data barang keluar berhasil ditambah!", false);
                formBarangKeluar.reset();
                selectKeluarId.value = ""; // Reset dropdown
                // Fitur Realtime akan otomatis mengambil data baru
            } catch (error) {
                console.error("Error add barang keluar:", error);
                showMessage(`Gagal simpan data: ${error.message}`, true);
            }
        });

    </script>
</body>
</html>
